using System;
using System.Drawing;
using System.Threading.Tasks;
using System.Windows.Forms;
using TaskManagerPlus.Controls;
using TaskManagerPlus.Services;

namespace TaskManagerPlus
{
    public partial class Form1 : Form
    {
        private ProcessMonitor processMonitor;
        private ProcessesTab processesTab;
        private PerformanceTab performanceTab;
        private bool isUpdating = false;

        public Form1()
        {
            InitializeComponent();
            processMonitor = new ProcessMonitor();
            InitializeTabs();
        }

        private void InitializeTabs()
        {
            processesTab = new ProcessesTab();
            processesTab.ProcessMonitor = processMonitor;
            processesTab.Dock = DockStyle.Fill;

            performanceTab = new PerformanceTab();
            performanceTab.ProcessMonitor = processMonitor;
            performanceTab.Dock = DockStyle.Fill;

            tabProcesses.Controls.Add(processesTab);
            tabPerformance.Controls.Add(performanceTab);
        }

        private async void Form1_Load(object sender, EventArgs e)
        {
            processesTab.Initialize();
            performanceTab.Initialize();
            
            await UpdateAllDataAsync();
            timerRefresh.Start();
        }

        private async Task UpdateAllDataAsync()
        {
            if (isUpdating) return;
            
            isUpdating = true;
            try
            {
                if (tabControl.SelectedTab == tabProcesses)
                {
                    await processesTab.LoadProcessesAsync();
                }
                
                await performanceTab.UpdatePerformanceAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Lỗi cập nhật: {ex.Message}");
            }
            finally
            {
                isUpdating = false;
            }
        }

        private async void timerRefresh_Tick(object sender, EventArgs e)
        {
            if (chkAutoRefresh.Checked && !isUpdating)
            {
                await UpdateAllDataAsync();
            }
        }

        private void chkAutoRefresh_CheckedChanged(object sender, EventArgs e)
        {
            timerRefresh.Enabled = chkAutoRefresh.Checked;
            if (chkAutoRefresh.Checked)
            {
                lblStatus.Text = "Đang cập nhật...";
                lblStatus.ForeColor = Color.FromArgb(25, 135, 84);
            }
            else
            {
                lblStatus.Text = "Đã tạm dừng";
                lblStatus.ForeColor = Color.FromArgb(108, 117, 125);
            }
        }

        private async void btnRefresh_Click(object sender, EventArgs e)
        {
            btnRefresh.Enabled = false;
            await UpdateAllDataAsync();
            btnRefresh.Enabled = true;
        }

        private void numRefreshInterval_ValueChanged(object sender, EventArgs e)
        {
            timerRefresh.Interval = (int)numRefreshInterval.Value * 1000;
        }

        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            timerRefresh.Stop();
            processMonitor?.Cleanup();
            base.OnFormClosing(e);
        }

        private async void tabControl_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (!isUpdating && tabControl.SelectedTab == tabProcesses)
            {
                await processesTab.LoadProcessesAsync();
            }
        }
    }
}
